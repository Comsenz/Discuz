(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{dWbn:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(s("y0A3")),i=r(s("VVfg")),o=r(s("6NK7"));function r(e){return e&&e.__esModule?e:{default:e}}t.default={data:function(){return{headBackShow:!0,rewardShow:!1,themeCon:!1,themeShow:!1,examineNum:"qqqq",rewardNumList:[{rewardNum:"0.01"},{rewardNum:"2"},{rewardNum:"5"},{rewardNum:"10"},{rewardNum:"20"},{rewardNum:"50"},{rewardNum:"88"},{rewardNum:"128"},{rewardNum:"666"}],qrcodeShow:!1,amountNum:"",codeUrl:"",showScreen:!1,request:!1,isliked:"",likedClass:"",imageShow:!1,index:1,firstpostImageList:[],siteMode:"",isPaid:"",situation1:!1,loginBtnFix:!1,loginHide:!1,siteInfo:!1,siteUsername:"",joinedAt:"",sitePrice:"",username:"",roleList:[],loading:!1,finished:!1,isLoading:!1,pageIndex:1,pageLimit:20,offset:100,groupId:"",menuStatus:!1,collectStatus:!1,collectFlag:"",postCount:0,postsList:"",likedUsers:[],rewardedUsers:[],token:!1,isWeixin:!1,isPhone:!1,isAndroid:!1,isiOS:!1,orderSn:"",payStatus:!1,payStatusNum:0,canViewPosts:"",canLike:"",canReply:"",themeUserId:"",userId:"",currentUserName:"",currentUserAvatarUrl:"",likedData:[]}},created:function(){var e=navigator.userAgent;this.isAndroid=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,this.isiOS=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),this.isWeixin=o.default.isWeixin().isWeixin,this.isPhone=o.default.isWeixin().isPhone,this.getInfo(),this.userId=i.default.getLItem("tokenId"),this.getUser(),this.detailsLoad(!0),this.themeCon?this.themeShow=!0:this.themeShow=!1},computed:{themeId:function(){return this.$route.params.themeId}},updated:function(){1!=this.isWeixin&&1!=this.isPhone&&this.limitWidth("detailsFooter")},methods:{downAttachment:function(e){this.isiOS&&this.$message("因iphone系统限制，您的手机无法下载文件。请使用安卓手机或电脑访问下载")},userArr:function(e){console.log(e),console.log("55544");var t=[];return e.forEach((function(e){t.push('<a  href="/home-page/'+e._data.id+'">'+e._data.username+"</a>")})),t.join(",")},limitWidth:function(e){console.log(e);var t=window.innerWidth;document.getElementById(e).style.width="640px",document.getElementById(e).style.marginLeft=(t-640)/2+"px"},getInfo:function(){var e=this;this.appFetch({url:"forum",method:"get",data:{include:["users"]}}).then((function(t){if(t.errors)throw e.$toast.fail(t.errors[0].code),new Error(t.error);console.log(t),e.siteInfo=t.readdata,e.isPayVal=t.readdata._data.siteMode,null!=e.isPayVal&&""!=e.isPayVal&&(e.isPayVal=t.readdata._data.siteMode,e.detailIf(e.isPayVal,!1))}))},getUser:function(){var e=this,t=i.default.getLItem("tokenId");this.userId=t,this.appFetch({url:"users",method:"get",splice:"/"+t,data:{include:"groups"}}).then((function(t){if(t.errors)throw e.$toast.fail(t.errors[0].code),new Error(t.error);e.currentUserName=t.readdata._data.username,e.currentUserAvatarUrl=t.readdata._data.avatarUrl,e.groupId=t.readdata.groups[0]._data.id,console.log(e.groupId)}))},detailIf:function(e){var t=i.default.getLItem("Authorization");this.token=t,"public"==e&&(console.log("公开"),t?(this.loginBtnFix=!1,this.loginHide=!0,this.menuStatus=!0):(console.log("公开，未登录"),this.loginBtnFix=!0,this.loginHide=!1))},footFix:function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;1==this.loginBtnFix&&(this.loginHide=!0,this.loginHide=e>80)},detailsLoad:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s="threads/"+this.themeId;return this.appFetch({url:s,method:"get",data:{"filter[isDeleted]":"no",include:["user","posts","posts.user","posts.likedUsers","posts.images","firstPost","firstPost.likedUsers","firstPost.images","firstPost.attachments","rewardedUsers","category"],"page[number]":this.pageIndex,"page[limit]":this.pageLimit}}).then((function(s){if(s.errors)throw e.$toast.fail(s.errors[0].code),new Error(s.error);if(console.log(s.readdata),console.log("1234"),e.finished=s.readdata.posts.length<e.pageLimit,t){e.collectStatus=s.readdata._data.isFavorite,e.essenceStatus=s.readdata._data.isEssence,e.stickyStatus=s.readdata._data.isSticky,e.collectStatus?e.collectFlag="已收藏":e.collectFlag="收藏",e.essenceStatus?e.essenceFlag="取消收藏":e.essenceFlag="收藏",e.stickyStatus?e.stickyFlag="取消置顶":e.stickyFlag="置顶",e.themeShow=!0,e.themeCon=s.readdata,e.canLike=s.readdata.firstPost._data.canLike,e.canViewPosts=s.readdata._data.canViewPosts,e.canReply=s.readdata._data.canReply,e.postsList=s.readdata.posts,e.likedUsers=s.readdata.firstPost.likedUsers,e.rewardedUsers=s.readdata.rewardedUsers,e.themeUserId=s.readdata.user._data.id;var a=e.themeCon.firstPost.images.length;if(0===a)return;for(var i=[],o=0;o<a;o++)i.push(e.themeCon.firstPost.images[o]._data.thumbUrl);e.firstpostImageList=i}else e.themeCon.posts=e.themeCon.posts.concat(s.readdata.posts)})).catch((function(t){e.loading&&1!==e.pageIndex&&e.pageIndex--})).finally((function(){console.log("22222222222222"),e.loading=!1}))},imageSwiper:function(e){this.imageShow=!0,ImagePreview({images:["https://img.yzcdn.cn/public_files/2017/09/05/4e3ea0898b1c2c416eec8c11c5360833.jpg","https://img.yzcdn.cn/public_files/2017/09/05/fd08f07665ed67d50e11b32a21ce0682.jpg"],startPosition:e,showIndex:!0,showIndicators:!0,loop:!1,onClose:function(e){e.index,e.url;console.log(e)}})},onChangeImgPreview:function(){this.index=index},shareTheme:function(){var e=a.default.devApiUrl+"/pay-circle-con/"+this.groupId,t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),t.className="oInput",t.style.display="none",this.$toast.success("分享链接已复制成功")},signOut:function(){i.default.removeLItem("tokenId"),i.default.removeLItem("Authorization"),this.$router.push({path:"/login-user"})},loginJump:function(){this.$router.push({path:"/login-user"}),i.default.setLItem("themeId",this.themeId)},registerJump:function(){this.$router.push({path:"/sign-up"}),i.default.setLItem("themeId",this.themeId)},jumpPerDet:function(e){this.token?this.$router.push({path:"/home-page/"+e}):this.$router.push({path:"/login-user",name:"login-user"})},bindScreen:function(){this.showScreen=!this.showScreen},themeOpera:function(e,t,s,a){if(this.token){var i=new Object;1==t?(this.collectStatus?i.isFavorite=!1:i.isFavorite=!0,"",this.themeOpeRequest(i,s,"1")):2==t?("",this.essenceStatus?i.isEssence=!1:i.isEssence=!0,this.themeOpeRequest(i,s,"2")):3==t?("",this.stickyStatus?i.isSticky=!1:i.isSticky=!0,this.themeOpeRequest(i,s,"3")):4==t?(i.isDeleted=!0,"",this.themeOpeRequest(i,s,"4")):this.$router.push({path:"/edit-topic/"+this.themeId})}else this.$router.push({path:"/login-user",name:"login-user"})},themeOpeRequest:function(e,t,s){var a=this,i="threads/"+this.themeId;this.appFetch({url:i,method:"patch",data:{data:{type:"threads",attributes:e},relationships:{category:{data:{type:"categories",id:t}}}}}).then((function(e){if(console.log(e),e.errors)throw a.$toast.fail(e.errors[0].code),new Error(e.error);"1"==s?(a.collectStatus=e.readdata._data.isFavorite,a.collectStatus?a.collectFlag="已收藏":a.collectFlag="收藏"):"2"==s?(a.essenceStatus=e.readdata._data.isEssence,a.essenceStatus?a.essenceFlag="取消加精":a.essenceFlag="加精"):"3"==s?(a.stickyStatus=e.readdata._data.isSticky,a.stickyStatus?a.stickyFlag="取消置顶":a.stickyFlag="置顶"):"4"==s&&(a.deletedStatus=e.readdata._data.isDeleted,a.deletedStatus&&a.$router.push({path:"/circle",name:"circle"}))}))},deleteOpear:function(e,t){var s=this;console.log(t);var a=new Object;a.isDeleted=!0,this.appFetch({url:"posts",splice:"/"+e,method:"patch",data:{data:{type:"posts",attributes:a}}}).then((function(e){if(e.errors)throw s.$toast.fail(e.errors[0].code),new Error(e.error);s.$toast.success("删除成功"),s.pageIndex=1,console.log(s.postsList),s.postsList.splice(t,1),console.log(s.postsList)}))},replyOpera:function(e,t,s,a,i){var o=this;if(console.log(e,t,s,a),this.token){var r=new Object;if(2==t){if(console.log(a),!a)return this.$toast.fail("没有权限，请联系站点管理员"),!1;r.isLiked=!s}var n="posts/"+e;this.appFetch({url:n,method:"patch",data:{data:{type:"posts",attributes:r}}}).then((function(e){if(e.errors)throw o.$toast.fail(e.errors[0].code),new Error(e.error);s?(o.postsList[i]._data.likeCount=o.postsList[i]._data.likeCount-1,o.postsList[i]._data.isLiked=!1):(o.postsList[i]._data.likeCount=o.postsList[i]._data.likeCount+1,o.postsList[i]._data.isLiked=!0),o.pageIndex=1}))}else this.$router.push({path:"/login-user",name:"login-user"})},footReplyOpera:function(e,t,s,a,i){var o=this;if(console.log(e,t,s,a),this.token){var r=new Object;if(3==t){if(!this.canLike)return this.$toast.fail("没有权限，请联系站点管理员"),!1;r.isLiked=!s}var n="posts/"+e;this.appFetch({url:n,method:"patch",data:{data:{type:"posts",attributes:r}}}).then((function(e){if(e.errors)throw o.$toast.fail(e.errors[0].code),new Error(e.error);s?(o.likedUsers.map((function(e,t,s){e._data.id===o.userId&&s.splice(t,1)})),o.userArr(o.likedUsers),o.themeCon.firstPost._data.isLiked=!1):(o.likedUsers.push({_data:{username:o.currentUserName,id:o.userId}}),o.themeCon.firstPost._data.isLiked=!0,console.log(o.themeCon.firstPost._data.isLiked)),o.pageIndex=1}))}else this.$router.push({path:"/login-user",name:"login-user"})},showRewardPopup:function(){this.token?(console.log(this.userId),console.log(this.themeUserId),this.userId==this.themeUserId?this.$toast.fail("不能打赏自己"):(this.rewardShow=!0,1!=this.isWeixin&&1!=this.isPhone&&this.rewardShow)):this.$router.push({path:"/login-user",name:"login-user"})},replyToJump:function(e,t,s){console.log(e,t,s),this.token?this.canReply?(this.$router.push({path:"/reply-to-topic/"+e+"/"+t}),i.default.setLItem("replyQuote",s)):this.$toast.fail("没有权限，请联系站点管理员"):this.$router.push({path:"/login-user",name:"login-user"})},onBridgeReady:function(e){var t=this;WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.data.attributes.wechat_js.appId,timeStamp:e.data.attributes.wechat_js.timeStamp,nonceStr:e.data.attributes.wechat_js.nonceStr,package:e.data.attributes.wechat_js.package,signType:"MD5",paySign:e.data.attributes.wechat_js.paySign});var s=setInterval((function(){("1"==t.payStatus||t.payStatusNum>10)&&clearInterval(s),t.getOrderStatus()}),3e3)},payClick:function(e){var t=this,s=this.appCommonH.isWeixin().isWeixin,a=this.appCommonH.isWeixin().isPhone;this.amountNum=e,s?this.getOrderSn(e).then((function(){t.orderPay(12).then((function(e){"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t.onBridgeReady(e),!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t.onBridgeReady(e)),document.attachEvent("onWeixinJSBridgeReady",t.onBridgeReady(e))):t.onBridgeReady(e)}))})):a?(console.log("手机浏览器"),this.getOrderSn(e).then((function(){t.orderPay(11).then((function(e){t.wxPayHref=e.readdata._data.wechat_h5_link,window.location.href=t.wxPayHref;var s=setInterval((function(){("1"==t.payStatus||t.payStatusNum>10)&&clearInterval(s),t.getOrderStatus()}),3e3)}))}))):(console.log("pc"),this.getOrderSn(e).then((function(){t.orderPay(10).then((function(e){console.log(e),t.codeUrl=e.readdata._data.wechat_qrcode,t.qrcodeShow=!0;var s=setInterval((function(){console.log(t.payStatusNum),t.getOrderStatus(),("1"==t.payStatus||t.payStatusNum>10)&&(console.log("已达上限"),clearInterval(s))}),3e3)}))})))},getOrderSn:function(e){var t=this;return this.appFetch({url:"orderList",method:"post",data:{type:2,thread_id:this.themeId,amount:e}}).then((function(e){console.log(e),t.orderSn=e.readdata._data.order_sn}))},orderPay:function(e){return this.appFetch({url:"orderPay",method:"post",splice:"/"+this.orderSn,data:{payment_type:e}}).then((function(e){return console.log(e),e})).catch((function(e){console.log(e)}))},getOrderStatus:function(){var e=this;return this.appFetch({url:"order",method:"get",splice:"/"+this.orderSn,data:{}}).then((function(t){if(console.log(t),t.errors)throw e.$toast.fail(t.errors[0].code),new Error(t.error);e.payStatus=t.readdata._data.status,console.log(t.readdata._data.status),e.payStatusNum++,("1"==e.payStatus||e.payStatusNum>10)&&(e.rewardShow=!1,e.qrcodeShow=!1,e.rewardedUsers.push({_data:{avatarUrl:e.currentUserAvatarUrl,id:e.userId}}),console.log(e.rewardedUsers),e.payStatusNum=11,console.log("重新请求"),clearInterval(pay))}))},onLoad:function(){this.loading=!0,this.pageIndex++,this.detailsLoad()},onRefresh:function(){var e=this;this.pageIndex=1,this.detailsLoad(!0).then((function(){e.$toast("刷新成功")})).catch((function(t){e.$toast("刷新失败")}))}},mounted:function(){},beforeRouteLeave:function(e,t,s){s()}}}}]);